## **浮点数**

浮点数是采用**`科学计数法`**的方式来表示的， 如 **8.345 * 10^0**

浮点数的「浮点」就是指，其小数点的位置是可以是**漂浮不定**的。如 **8.345 * 10^0 ，**  **83.45 * 10^-1**

### **浮点数表示**
$$
V = (-1)^S * M * R^E
$$

- S（sign）：
    - 符号位，取值 0 或 1，决定一个数字的符号，0 表示正，1 表示负
- M（mantissa/precision/fraction-**the precision of the number**）：
    - 尾数，用小数表示，例如 8.345 * 10^0，8.345 就是尾数
- R（base）：基数，表示十进制数 R 就是 10，表示二进制数 R 就是 2
- E（exponent/range-**the range  of the number**）：
    - 指数，用整数表示，例如前面看到的 10^-1，-1 即是指数
<img src="https://github.com/hinswhale/AI-Learning/assets/22999866/6be8af40-4e75-45e5-8677-c05470105ee7" style="width: 400px; height: 150px;">

存储方式：

<img src="https://github.com/hinswhale/AI-Learning/assets/22999866/e6c6da04-c569-4e25-91c8-583e206e01cf" style="width: 400px; height: 150px;">


### **流程：十进制数小数**转换为**浮点数**

以173.8125为例：

1. **10进制转成2进制，分为整数/小数两部分**
    1. 整数部分：173(D) = 10101101(B)
    2. 小数部分：0.8125(D) = 0.1101(B)
2. **用二进制科学计数法表示**：173.8125(D) = 10101101.1101(B) =1.01011011101* 2^7(B)
3. **按公式对应**：符号位 S = 0，尾数 M = 1.01011011101(B)，指数 E = 7(D) = 111(B)。
4. **按存储方式**：填充到32 bit 位置

**补充：**

**整数部分（25）：** 

<img src="https://github.com/hinswhale/AI-Learning/assets/22999866/5ec97b16-fdec-4fe4-b640-0dde48059a1d" style="width: 400px; height: 200px;">


**小数部分（**0..8125**）**

<img src="https://github.com/hinswhale/AI-Learning/assets/22999866/a2c8ec93-aaa8-455e-a356-95978583a372" style="width: 400px; height: 200px;">

---

# **标准浮点数的表示**

### 规范化浮点数（normal number）

IEEE 754 标准定义了浮点数的二进制表示,包括以下三部分

1. 符号位 (S): 1 bit, 0 表示正数, 1 表示负数
2. 指数位 (E): 8 bit (单精度), 11 bit (双精度), 用移码表示, 
    
    实际指数 = E - 127 (单精度), E - 1023 (双精度)
    
    float E 的取值范围为 -127 ~ 128。double 样取值范围 : -1023 ~ 1024。
    
3. 尾数位 (M / **fraction**): 23 bit (单精度), 52 bit (双精度), 隐藏了最高位的 1, 所以实际有效位数为 24 bit (单精度), 53 bit (双精度)

因此, IEEE 754 浮点数的二进制表示可以表示为 (-1)^S * 1.M * 2^(E-bias)。

<img src="https://github.com/hinswhale/AI-Learning/assets/22999866/21eb408d-70a6-4b85-ae7c-824fa5947cfc" style="width: 500px; height: 200px;">
<img src="https://github.com/hinswhale/AI-Learning/assets/22999866/7aee4cb2-7a30-4200-ae62-68612b59e7ca" style="width: 500px; height: 200px;">

---

### 详细说明：

真值 = $(-1)^S * 1.M * 2^{(E-127)}$， **其中(-1)^S表示符号**

**⚠️ 尾数部分：IEEE754 规定，在二进制数中，通过移位，将小数点前面的值固定为 1（尾数 M 的第一位）**

**因为规定第 1 位永远为 1**，因此省略不存(设置为**隐藏位**)**，所以fp32** M为23 bit ,实际表示24bit.

如 ：0.15625(D) =0.00101(B)=1.01 * 2^(-3)(**固定小数点前面的值为1**, 尾数部分: **1**.01 指数部分: -1), 只需存 0100

**⚠️  指数部分：** IEEE754 规定，**2ᵉ⁻¹-1 的值是 0，其中 e 表示指数部分的位数，小于这个值表示负数，大于这个值表示正数（The Biased exponent**（有偏指数）**）。**

- 单精度浮点数而言， 2⁸⁻¹-1 = 127 是 0；
- 双精度浮点数，2¹¹⁻¹-1 = 1023 是 0

如：十进制数 0.15625，转为二进制是 0.00101，标准IEEE 754表示：1.01 * 2^(-3)

-3 的实际值是 127 - 3 = 124（ 如果127 →0， 则124实际表示-3， 即单精度浮点数下-3实际值是124）

124 转为二进制就是 1111100。

即：根据IEEE 754，0.15625可表示为：S=0, M=0100, E=124(D)=1111100(B)

<img src="https://github.com/hinswhale/AI-Learning/assets/22999866/374051f3-22c9-4881-a02c-37081fc75e79" style="width: 500px; height: 200px;">

总结：

1. 表示
    - 单精度浮点数 float：32 位，符号位 S 占 1 bit，指数 E 占 8 bit，尾数 M 占 23 bit
    - 双精度浮点数 float：64 位，符号位 S 占 1 bit，指数 E 占 11 bit，尾数 M 占 52 bit
2. 表示范围：
- float 能表示的最大二进制数为 +1.1.11111…1 * 2^127（小数点后23个1），而二进制 1.11111…1 ≈ 2，所以 float 能表示的最大数为 2^128 = 3.4 * 10^38，即 float 的表示范围为：-3.4 * 10^38 ~ 3.4 * 10 ^38。
- float 能表示的最小二进制数为 0.0000….1（小数点后22个0，1个1），用十进制数表示就是 1/2^23。
- double 能表示的最大二进制数为 +1.111…111（小数点后52个1） * 2^1023 ≈ 2^1024 = 1.79 * 10^308，所以 double 能表示范围为：-1.79 * 10^308 ~ +1.79 * 10^308。
- double 的最小精度为：0.0000…1(51个0，1个1)，用十进制表示就是 1/2^52。

<aside>
💡

**🔎 表示范围 详细计算，以单精度为例**

单精度最大值：0 11111110 11111111111111111111111 = 1.M * 2^127  = 3.402823×10^38

   最小值：     0 00000000 00000000000000000000001 =  2^(-23) (尾数部分的每一位都是2^(−𝑛)，其中𝑛是该位的位置。)

---

- 符号位：0（表示正数）
- 指数位：11111110（二进制），转换为十进制为 254，减去偏移值（127），因此实际指数为 254 - 127 = 127
- 尾数位：11111111111111111111111（二进制），添加一个隐藏的 1，即 1.11111111111111111111111

  $(1+2^{-1}+2^{-2}+…+2^{-23}) * 2^{127} =(2-2^{-23})* 2^{127}$ 

</aside>

- 最大正数: S=0，E=254，e=254-127=127，尾数M=111 1111 1111 1111 1111 1111，其机器码为：0 11111110 111 1111 1111 1111 1111 1111。
    
      $(−1)^S×1.M×2^e=+(1.11111111111111111111111)×2^{127}≈3.402823×10^{38}$
    
- 最小正数: S=0，E=1，e=1-127=-126，尾数M=0，其机器码为0 00000001 000 0000 0000 0000 0000 0000。
    
      $(−1)^S×1.M×2^e=+(1.0)×2^{−126}≈1.175494 * 10^{−38}$
    
- 最大负数: S=1，E=1，e=1-127==-126，尾数M=0，机器码与最小正数的符号位相反，其他均相同，为：1 00000001 000 0000 0000 0000 0000 0000。
    
    $(−1)^S×1.M×2^e=−(1.0)×2^{−126}≈−1.175494 * 10^{−38}$
    
- 最小负数: S=0，E=254，e=254-127=127，尾数M=111 1111 1111 1111 1111 1111，其机器码为：1 11111110 111 1111 1111 1111 1111 1111。
    
    $(−1)^S×1.M×2^e=+(111 1111 1111 1111 1111 1111)×2^{−127}≈-3.402823* 10^{38}$
    

---

### ***非规范化浮点数**（denormal number）*

因为按之前的规定，尾数部分有一个省略的前导 1，因此无法表示 0。

***IEEE754 规定**：当指数位全是 0，尾数部分不全为 0，尾数部分没有省略的前导 1，同时**指数部分的偏移值比规范形式的偏移值小 1**，即单精度是 -126，双精度是 -2046。这种形式的浮点数叫**非规范化浮点数（denormal number）**。*

真值 = $(-1)^S * 0.M * 2^{-126}$

最小的正非规格化数: $2^{−126}$

最大的非规格化数: $2^{−126}×(1−2^{−23})$

---
|          | 单精度 | 双精度 |
| ---      | ---   | ---   |
| 位数      | 32位  | 64位  |
| 符号位 \(S\) | 1 bit | 1 bit |
| 指数 \(E\)   | 8 bit | 11 bit|
| 尾数 \(M\)   | 23 bit| 52 bit|
| 表示范围    | \(-3.4 \times 10^{38}\) ~ \(3.4 \times 10^{38}\) | \(-1.79 \times 10^{308}\) ~ \(+1.79 \times 10^{308}\) |
| 精度       | \(1/2^{23}\) | \(1/2^{52}\) |
| 0点       | \(2^{8-1}-1 = 127\) | \(2^{11-1}-1 = 1023\) |
| 指数 \(E\) 的范围 | 8位阶码范围：[0, 255] <br>偏移值：127 <br>指数表达式： \(2^{(exponentbits-127)}\) <br> 指数取值范围： \([-126,127]\) <br> 其中 −127保留给非规格化数，+128保留给 infinity.<br> 因此32位浮点数的指数取值范围是 [−126,127]| 阶码范围为 [0, 2047]（11位能表示的最大值）。 <br> 偏移值：1023 <br>  指数表达式为 \(2^{(exponent bits-1023)}\) <br> 指数的取值范围为 \([-1022, 1023]\)。 <br> 其中，-1022 保留给非规格化数，而 +1023 保留给无穷大。<br>  总之，64位双精度浮点数的指数取值范围是 \([-1021, 1023]\)。


### **浮点数分类小结**

- 指数 E 非全 0 且非全 1 — **规范化浮点数（normal number）**：范围：
    - $(-2^{128}, -2^{-126}] \cup [2^{-126}, 2^{128})$
- 指数 E 全 0，尾数非 0 — **非规格化数*（denormal number）***：尾数隐藏位不再是 1，而是 0(M = 0.xxxxx)，这样可以表示 0 和很小的数$(-2^{-126}, 2^{-126})$, 但会存在 +0 和 -0：即所有位全是 0 时是 +0；符号位是 1，其他位是 0 时是 -0。
- 指数 E 全 1，尾数全 0：正无穷大/负无穷大（**+infinity 和 -infinity**）（正负取决于 S 符号位）
- 指数 E 全 1，尾数不全为0：**NaN**(Not a Number) ，如对 -1 进行开根号时

这种表示是具有连续性的。这也就是为什么非规范化浮点数指数规定为比规范形式的偏移值小 1（即单精度为 -126，双精度为 -2046）

<img src="https://github.com/hinswhale/AI-Learning/assets/22999866/65cb225e-e9fd-43d8-97a5-91cef244bcbb" style="width: 500px; height: 200px;">

<img src="https://github.com/hinswhale/AI-Learning/assets/22999866/b3510665-70a9-405f-8a96-d705d6dd7994" style="width: 500px; height: 200px;">

<img src="https://github.com/hinswhale/AI-Learning/assets/22999866/e8076053-f13f-4d28-88df-d08953c012f9" style="width: 500px; height: 200px;">



### 计算工具

1. https://play.studygolang.com/p/pg0QNQtBHYx。
2. https://baseconvert.com/ieee-754-floating-point。

### 参考资料

1. [计算机系统基础（四）浮点数](https://polarisxu.studygolang.com/posts/basic/diagram-float-point/)
2. [15 张图带你深入理解浮点数](https://polarisxu.studygolang.com/posts/basic/diagram-float-point/)
